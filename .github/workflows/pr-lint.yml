name: PR Lint & Format Check

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write  # ç”¨äºŽåœ¨ PR ä¸­è¯„è®ºç»“æžœ

jobs:
  lint-and-format:
    name: Lint & Format Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Set up pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Install backend dependencies
        run: |
          echo "ðŸ“¦ Installing backend dependencies..."
          uv sync --dev

      - name: Install frontend dependencies
        run: |
          echo "ðŸ“¦ Installing frontend dependencies..."
          cd frontend
          pnpm install
          cd ..

      - name: Run unified lint script (check-only mode)
        run: |
          echo "ðŸš€ Running unified lint script in check-only mode..."
          uv run python scripts/lint.py --check-only

      - name: Run backend lint and format check
        if: always()
        run: |
          echo "ðŸ Checking backend Python code..."
          uv run ruff check --output-format=github

          echo "ðŸŽ¨ Checking backend Python format..."
          uv run ruff format --check --diff

      - name: Run frontend lint and format check
        if: always()
        run: |
          echo "ðŸ“± Checking frontend JavaScript/TypeScript code..."
          cd frontend
          pnpm lint

          echo "ðŸŽ¨ Checking frontend format..."
          pnpm format:check

          echo "ðŸ”· Running TypeScript type check..."
          pnpm type-check
          cd ..

      - name: Check for uncommitted changes
        if: always()
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "âŒ There are uncommitted changes after running formatters!"
            echo "Please run the following locally to fix:"
            echo "  uv run python scripts/lint.py"
            echo ""
            echo "Or run the individual commands:"
            echo "  Backend: uv run ruff check --fix && uv run ruff format"
            echo "  Frontend: cd frontend && pnpm lint --fix && pnpm format"
            echo ""
            echo "Files with changes:"
            git status --porcelain
            exit 1
          else
            echo "âœ… No formatting changes detected"
          fi

      - name: Comment PR with results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸš€ Lint & Format Check Results')
            );

            const status = '${{ job.status }}' === 'success' ? 'âœ… PASSED' : 'âŒ FAILED';
            const color = '${{ job.status }}' === 'success' ? 'green' : 'red';

            const commentBody = `
            ## ðŸš€ Lint & Format Check Results: ${status}

            ### What was checked:
            - ðŸ **Backend**: Ruff linting + formatting
            - ðŸ“± **Frontend**: ESLint + Prettier + TypeScript types
            - ðŸ”§ **Unified**: Custom lint script validation

            ${'${{ job.status }}' === 'success' ? `
            ### âœ… All checks passed!
            Your code follows the project's style guidelines.

            ### Checks performed:
            - Backend Ruff lint âœ…
            - Backend Ruff format âœ…
            - Frontend ESLint âœ…
            - Frontend Prettier format âœ…
            - Frontend TypeScript types âœ…
            - Unified lint script âœ…
            ` : `
            ### âŒ Some checks failed!

            #### How to fix:
            1. Run locally to auto-fix most issues:
            \`\`\`bash
            uv run python scripts/lint.py
            \`\`\`

            2. Commit the fixes and push:
            \`\`\`bash
            git add .
            git commit -m "fix: apply lint and format fixes"
            git push
            \`\`\`

            3. The checks will run again automatically.

            #### Individual fix commands:
            **Backend:**
            \`\`\`bash
            uv run ruff check --fix
            uv run ruff format
            \`\`\`

            **Frontend:**
            \`\`\`bash
            cd frontend
            pnpm lint --fix
            pnpm format
            cd ..
            \`\`\`
            `}

            ---
            *This is an automated check. For questions, ask in the PR discussion.*
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody,
              });
            }

  # æž„å»ºä»»åŠ¡ - ä»…åœ¨ lint é€šè¿‡åŽè¿è¡Œ
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint-and-format
    if: always() && needs.lint-and-format.result == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Set up pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Build frontend
        run: |
          cd frontend
          pnpm build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/
          retention-days: 7
